<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>¬øEs A√±o Nuevo?</title>
  <meta name="theme-color" content="#060a1f" />

  <style>
    :root{
      --bg1:#05061a; --bg2:#0b0f2a;
      --card: rgba(255,255,255,.06);
      --stroke: rgba(255,255,255,.12);
      --text: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.68);
      --gold:#ffd166; --pink:#ff4d8d; --cyan:#37d6ff; --neon:#7c5cff; --mint:#2ee6a6;
    }
    *{ box-sizing:border-box; }
    html, body { height: 100%; }

    body{
      margin:0; min-height:100vh;
      display:flex; align-items:center; justify-content:center;
      padding:28px; color:var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, "Noto Sans", Arial;
      background:
        radial-gradient(900px 500px at 15% 15%, rgba(55,214,255,.16), transparent 60%),
        radial-gradient(900px 500px at 85% 25%, rgba(255,77,141,.14), transparent 60%),
        radial-gradient(900px 650px at 50% 120%, rgba(124,92,255,.20), transparent 60%),
        linear-gradient(180deg, var(--bg1), var(--bg2));
      overflow:hidden;
    }

    canvas#fx{ position:fixed; inset:0; pointer-events:none; z-index:0; }

    .stars{
      position:fixed; inset:0; pointer-events:none; z-index:0; opacity:.55;
      background-image:
        radial-gradient(1px 1px at 12% 18%, rgba(255,255,255,.55), transparent 60%),
        radial-gradient(1px 1px at 84% 22%, rgba(255,255,255,.40), transparent 60%),
        radial-gradient(1px 1px at 55% 62%, rgba(255,255,255,.35), transparent 60%),
        radial-gradient(1px 1px at 32% 78%, rgba(255,255,255,.42), transparent 60%),
        radial-gradient(1px 1px at 70% 86%, rgba(255,255,255,.28), transparent 60%);
      filter: blur(.15px);
    }

    .wrap{ width:min(900px,100%); text-align:center; position:relative; z-index:1; }

    .card{
      position:relative;
      padding:28px 22px 22px;
      border-radius:22px;
      background:var(--card);
      border:1px solid var(--stroke);
      backdrop-filter: blur(10px);
      box-shadow:0 30px 90px rgba(0,0,0,.45);
      overflow:hidden;
    }

    .glowTop{
      position:absolute; inset:-90px -110px auto -110px; height:210px;
      background: radial-gradient(closest-side, rgba(124,92,255,.18), transparent 70%);
      filter: blur(10px); pointer-events:none;
    }

    .badge{
      display:inline-flex; align-items:center; gap:10px;
      padding:8px 12px; border-radius:999px;
      border:1px solid var(--stroke);
      background:rgba(0,0,0,.18);
      color:var(--muted);
      font-size:13px;
      margin-bottom:14px;
      user-select:none;
    }

    .dot{
      width:9px; height:9px; border-radius:50%;
      background:var(--mint);
      box-shadow:0 0 0 6px rgba(46,230,166,.12);
      animation:pulse 1.6s ease-in-out infinite;
      flex:0 0 auto;
    }
    @keyframes pulse{ 0%,100%{ transform:scale(1); opacity:1 } 50%{ transform:scale(1.2); opacity:.8 } }

    .tzLabel{ color: rgba(255,255,255,.62); margin-right:4px; }

    select{
      appearance:none;
      border:1px solid rgba(255,255,255,.18);
      background:rgba(0,0,0,.20);
      color:rgba(255,255,255,.90);
      padding:6px 28px 6px 10px;
      border-radius:999px;
      font-size:13px;
      cursor:pointer;
      outline:none;
    }
    .selectWrap{ position:relative; display:inline-flex; align-items:center; }
    .chev{ position:absolute; right:10px; opacity:.7; pointer-events:none; font-size:12px; transform: translateY(1px); }

    h1{
      margin:10px 0 6px;
      font-size:clamp(42px,6vw,76px);
      letter-spacing:-.02em;
      line-height:1.05;
    }

    .ansText{ display:inline-block; vertical-align:baseline; }
    .yes .ansText{
      background:linear-gradient(90deg,var(--gold),var(--pink),var(--cyan));
      -webkit-background-clip:text; background-clip:text;
      color:transparent;
      text-shadow: 0 0 40px rgba(255,209,102,.06);
    }
    .no .ansText{
      background:linear-gradient(90deg,#fff,rgba(255,255,255,.55));
      -webkit-background-clip:text; background-clip:text;
      color:transparent;
    }

    /* Emoji separado (sin background-clip) para que SIEMPRE se vea */
    .ansEmoji{
      display:inline-block;
      margin-left:.28em;
      color: rgba(255,255,255,.92);
      text-shadow: 0 10px 28px rgba(0,0,0,.35);
      transform: translateY(.04em);
    }

    .sub{ margin:8px 0 0; font-size:clamp(16px,2.2vw,20px); color:var(--muted); }
    .big{ margin-top:14px; font-size:clamp(18px,2.4vw,22px); color: rgba(255,255,255,.86); }

    .btnRow{ margin-top: 16px; display:flex; justify-content:center; }
    .pushBtn{
      border:1px solid rgba(255,255,255,.18);
      background:rgba(0,0,0,.22);
      color:rgba(255,255,255,.92);
      padding:16px 22px;
      border-radius:999px;
      cursor:pointer;
      font-size:15px;
      letter-spacing:.2px;
      user-select:none;
      display:inline-flex;
      align-items:center;
      gap:12px;
      box-shadow: 0 22px 60px rgba(0,0,0,.42), 0 0 0 1px rgba(255,255,255,.05) inset;
      transition: transform .08s ease, background .15s ease, border-color .15s ease, box-shadow .15s ease;
      min-width: 340px;
      justify-content:center;
    }
    .pushBtn:hover{
      background:rgba(0,0,0,.30);
      border-color: rgba(255,255,255,.28);
      box-shadow: 0 28px 70px rgba(0,0,0,.52), 0 0 0 1px rgba(255,255,255,.06) inset;
    }
    .pushBtn:active{ transform: translateY(2px); }
    .pushBtn:disabled{ opacity:.60; cursor:not-allowed; transform:none; }

    .weather{
      margin-top:18px;
      text-align:left;
      border-top:1px solid rgba(255,255,255,.12);
      padding-top:14px;
    }
    .weatherTitle{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      color: rgba(255,255,255,.86);
      font-size: 13px;
      letter-spacing: .2px;
      margin-bottom: 10px;
      user-select:none;
    }
    .weatherGrid{ display:grid; grid-template-columns:1fr 1fr; gap:10px; }
    .wxCard{
      border:1px solid rgba(255,255,255,.12);
      background:rgba(0,0,0,.14);
      border-radius:16px;
      padding:12px;
    }
    .wxTop{ display:flex; align-items:center; justify-content:space-between; margin-bottom:6px; color:rgba(255,255,255,.86); font-size:13px; }
    .wxLine{ color:rgba(255,255,255,.72); font-size:13px; line-height:1.35; }
    .wxFooter{ margin-top:10px; color:rgba(255,255,255,.50); font-size:12px; line-height:1.35; }

    @media(max-width:520px){
      .weatherGrid{ grid-template-columns:1fr; }
      .pushBtn{ min-width: 100%; }
    }
  </style>
</head>

<body>
  <div class="stars"></div>
  <canvas id="fx"></canvas>

  <div class="wrap">
    <div class="card">
      <div class="glowTop"></div>

      <div class="badge">
        <span class="dot"></span>
        <span class="tzLabel">Horario:</span>
        <span class="selectWrap">
          <select id="tzSelect" aria-label="Seleccionar zona horaria"></select>
          <span class="chev">‚ñæ</span>
        </span>
      </div>

      <h1 id="answer" class="no">
        <span class="ansText" id="answerText">‚Ä¶</span>
        <span class="ansEmoji" id="answerEmoji">‚Ä¶</span>
      </h1>

      <p class="sub" id="subtitle">‚Ä¶</p>
      <p class="big" id="countdown">‚Ä¶</p>

      <div class="btnRow">
        <button class="pushBtn" id="btnFire" type="button">
          <span style="font-size:18px">üéÜ</span>
          <span id="btnFireLabel">Lanzar fuegos artificiales</span>
        </button>
      </div>

      <section class="weather">
        <div class="weatherTitle">
          <span>üå§Ô∏è Clima (m√≠n / m√°x)</span>
          <span style="color:rgba(255,255,255,.55); font-size:12px;" id="wxLoc"></span>
        </div>

        <div class="weatherGrid">
          <div class="wxCard">
            <div class="wxTop"><div>31/12/2025</div><div id="wxEmoji31">‚Ä¶</div></div>
            <div class="wxLine" id="wxLine31">Cargando‚Ä¶</div>
          </div>

          <div class="wxCard">
            <div class="wxTop"><div>01/01/2026</div><div id="wxEmoji01">‚Ä¶</div></div>
            <div class="wxLine" id="wxLine01">Cargando‚Ä¶</div>
          </div>
        </div>

        <div class="wxFooter" id="wxFooter"></div>
      </section>
    </div>
  </div>

<script>
  // =========================
  // Config
  // =========================
  const TARGET_31 = "2025-12-31";
  const TARGET_01 = "2026-01-01";

  const TZ_OPTIONS = [
    { id:"America/Argentina/Buenos_Aires", label:"Argentina (Buenos Aires)" },
    { id:"America/Mexico_City", label:"M√©xico (CDMX)" },
    { id:"America/Santiago", label:"Chile (Santiago)" },
    { id:"America/Lima", label:"Per√∫ (Lima)" },
    { id:"America/Bogota", label:"Colombia (Bogot√°)" },
    { id:"America/New_York", label:"USA (New York)" },
    { id:"America/Los_Angeles", label:"USA (Los √Ångeles)" },
    { id:"Europe/Madrid", label:"Espa√±a (Madrid)" }
  ];

  // Coordenadas base por TZ (aprox ciudad principal)
  const TZ_GEO = {
    "America/Argentina/Buenos_Aires": { name:"Buenos Aires (CABA)", lat:-34.6037, lon:-58.3816 },
    "America/Mexico_City":           { name:"Ciudad de M√©xico",     lat: 19.4326, lon:-99.1332 },
    "America/Santiago":              { name:"Santiago",            lat:-33.4489, lon:-70.6693 },
    "America/Lima":                  { name:"Lima",                lat:-12.0464, lon:-77.0428 },
    "America/Bogota":                { name:"Bogot√°",              lat:  4.7110, lon:-74.0721 },
    "America/New_York":              { name:"New York",            lat: 40.7128, lon:-74.0060 },
    "America/Los_Angeles":           { name:"Los √Ångeles",          lat: 34.0522, lon:-118.2437 },
    "Europe/Madrid":                 { name:"Madrid",              lat: 40.4168, lon: -3.7038 }
  };

  // Fallback prolijo si falla la API (solo como ‚Äúplan B‚Äù)
  const FALLBACK = {
    "America/Argentina/Buenos_Aires": { min31:20, max31:39, e31:"üî•", min01:17, max01:28, e01:"üå§Ô∏è" },
    "America/Mexico_City":           { min31: 8, max31:21, e31:"‚òÄÔ∏è", min01: 8, max01:21, e01:"‚òÄÔ∏è" },
    "America/Santiago":              { min31:14, max31:28, e31:"‚òÄÔ∏è", min01:14, max01:28, e01:"‚òÄÔ∏è" },
    "America/Lima":                  { min31:20, max31:27, e31:"üå§Ô∏è", min01:20, max01:27, e01:"üå§Ô∏è" },
    "America/Bogota":                { min31: 9, max31:19, e31:"üå¶Ô∏è", min01: 9, max01:19, e01:"üå¶Ô∏è" },
    "America/New_York":              { min31:-2, max31: 5, e31:"ü•∂", min01:-2, max01: 5, e01:"ü•∂" },
    "America/Los_Angeles":           { min31: 8, max31:19, e31:"üå§Ô∏è", min01: 8, max01:19, e01:"üå§Ô∏è" },
    "Europe/Madrid":                 { min31: 1, max31:10, e31:"‚ùÑÔ∏è", min01: 1, max01:10, e01:"‚ùÑÔ∏è" },
  };

  const STORAGE_KEY = "esanionuevo_tz";
  let TZ = localStorage.getItem(STORAGE_KEY) || "America/Argentina/Buenos_Aires";

  // =========================
  // Helpers (TZ-safe "now")
  // =========================
  function nowInTZAsUTCDate(tz){
    const parts = new Intl.DateTimeFormat("en-US",{
      timeZone:tz,
      year:"numeric",month:"2-digit",day:"2-digit",
      hour:"2-digit",minute:"2-digit",second:"2-digit",
      hour12:false
    }).formatToParts(new Date());
    const get = t => Number(parts.find(p=>p.type===t).value);
    return new Date(Date.UTC(get("year"), get("month")-1, get("day"), get("hour"), get("minute"), get("second")));
  }

  function isNewYearInTZ(nowTZ_utcEncoded){
    return nowTZ_utcEncoded.getUTCMonth() === 0 && nowTZ_utcEncoded.getUTCDate() === 1;
  }

  function nextNewYearInTZ(nowTZ_utcEncoded){
    const y = nowTZ_utcEncoded.getUTCFullYear();
    const m = nowTZ_utcEncoded.getUTCMonth() + 1;
    const d = nowTZ_utcEncoded.getUTCDate();
    const next = (m > 1 || (m === 1 && d > 1)) ? y + 1 : y;
    return new Date(Date.UTC(next, 0, 1, 0, 0, 0));
  }

  function pad2(n){ return String(n).padStart(2,"0"); }

  function setAnswer({ mode, text, emoji }){
    document.getElementById("answer").className = mode;
    document.getElementById("answerText").textContent = text;
    document.getElementById("answerEmoji").textContent = emoji;
  }

  // =========================
  // Main text
  // =========================
  function updateText(){
    const nowTZ = nowInTZAsUTCDate(TZ);

    const subtitle = document.getElementById("subtitle");
    const countdown = document.getElementById("countdown");

    if(isNewYearInTZ(nowTZ)){
      setAnswer({ mode:"yes", text:"S√≠", emoji:"üéâ" });
      subtitle.textContent = "¬°Hoy es A√±o Nuevo! ü•Ç";
      countdown.textContent = "Salud, abrazos y nuevos comienzos ‚ú®";
      return;
    }

    const diffMs = nextNewYearInTZ(nowTZ) - nowTZ;
    const totalSec = Math.max(0, Math.ceil(diffMs / 1000));
    const hours = Math.floor(totalSec / 3600);
    const minutes = Math.floor((totalSec % 3600) / 60);
    const seconds = totalSec % 60;

    countdown.textContent = `Faltan ${hours}h ${pad2(minutes)}m ${pad2(seconds)}s para A√±o Nuevo.`;

    // Siempre debe estar el "No"
    if(hours <= 24){
      setAnswer({ mode:"yes", text:"No", emoji:"ü§©" });
      subtitle.textContent = "No, pero‚Ä¶ estamos a nada üéá";
    } else if(hours <= 24*7){
      setAnswer({ mode:"yes", text:"No", emoji:"üòÑ" });
      subtitle.textContent = "No, pero‚Ä¶ falta poco üé∂";
    } else {
      setAnswer({ mode:"no", text:"No", emoji:"üò¢" });
      subtitle.textContent = "Todav√≠a no es A√±o Nuevo.";
    }
  }

  // =========================
  // Weather (real for fixed dates)
  // =========================
  function codeToEmoji(c){
    c = Number(c);
    if(c === 0) return "‚òÄÔ∏è";
    if(c === 1 || c === 2) return "üå§Ô∏è";
    if(c === 3) return "‚òÅÔ∏è";
    if(c === 45 || c === 48) return "üå´Ô∏è";
    if((c >= 51 && c <= 67) || (c >= 80 && c <= 82)) return "üåßÔ∏è";
    if(c >= 71 && c <= 77) return "üå®Ô∏è";
    if(c >= 95) return "‚õàÔ∏è";
    return "üåô";
  }

  function setWx(dayKey, label, emoji, min, max){
    document.getElementById(`wxEmoji${dayKey}`).textContent = emoji;
    document.getElementById(`wxLine${dayKey}`).textContent =
      `${label}: m√≠n ${Math.round(min)}¬∞ ¬∑ m√°x ${Math.round(max)}¬∞`;
  }

  function setWxLoading(){
    document.getElementById("wxLoc").textContent = "‚Ä¶";
    document.getElementById("wxEmoji31").textContent = "‚Ä¶";
    document.getElementById("wxEmoji01").textContent = "‚Ä¶";
    document.getElementById("wxLine31").textContent = "Cargando‚Ä¶";
    document.getElementById("wxLine01").textContent = "Cargando‚Ä¶";
    document.getElementById("wxFooter").textContent = "";
  }

  function applyFallback(){
    const geo = TZ_GEO[TZ] || TZ_GEO["America/Argentina/Buenos_Aires"];
    const fb = FALLBACK[TZ] || FALLBACK["America/Argentina/Buenos_Aires"];

    document.getElementById("wxLoc").textContent = `üìç ${geo.name}`;
    setWx("31", "31/12/2025", fb.e31, fb.min31, fb.max31);
    setWx("01", "01/01/2026", fb.e01, fb.min01, fb.max01);
    document.getElementById("wxFooter").textContent =
    #  "No pude traer el pron√≥stico ahora. Mostrando valores t√≠picos (fallback).";
  }

  async function loadWeatherForTZ(){
    setWxLoading();

    const geo = TZ_GEO[TZ] || TZ_GEO["America/Argentina/Buenos_Aires"];
    document.getElementById("wxLoc").textContent = `üìç ${geo.name}`;

    const url = new URL("https://api.open-meteo.com/v1/forecast");
    url.searchParams.set("latitude", String(geo.lat));
    url.searchParams.set("longitude", String(geo.lon));
    url.searchParams.set("timezone", TZ); // clave: alinear fechas
    url.searchParams.set("forecast_days", "16");
    url.searchParams.set("daily", "temperature_2m_max,temperature_2m_min,weather_code");

    const ctrl = new AbortController();
    const t = setTimeout(()=>ctrl.abort(), 6500);

    try{
      const res = await fetch(url.toString(), { cache:"no-store", signal: ctrl.signal });
      clearTimeout(t);
      if(!res.ok) throw new Error("HTTP " + res.status);
      const data = await res.json();

      const daily = data?.daily || {};
      const times = daily.time || [];
      const i31 = times.indexOf(TARGET_31);
      const i01 = times.indexOf(TARGET_01);

      if(i31 === -1 || i01 === -1){
        // si no vienen, puede ser ventana/fetch raro; mostramos fallback prolijo
        applyFallback();
        document.getElementById("wxFooter").textContent =
          "El proveedor no devolvi√≥ esas fechas en la ventana del pron√≥stico. Mostrando fallback.";
        return;
      }

      setWx("31", "31/12/2025",
        codeToEmoji(daily.weather_code[i31]),
        daily.temperature_2m_min[i31],
        daily.temperature_2m_max[i31]
      );

      setWx("01", "01/01/2026",
        codeToEmoji(daily.weather_code[i01]),
        daily.temperature_2m_min[i01],
        daily.temperature_2m_max[i01]
      );

      document.getElementById("wxFooter").textContent =
        "Fuente: Open-Meteo ¬∑ Fechas calculadas en tu zona horaria seleccionada.";
    } catch(e){
      clearTimeout(t);
      applyFallback();
    }
  }

  // =========================
  // Fireworks (realistic)
  // =========================
  const FX = (() => {
    const canvas = document.getElementById("fx");
    const ctx = canvas.getContext("2d", { alpha:true });

    let w=0, h=0, dpr=1;
    let party = false;

    const rockets = [];
    const sparks = [];

    const isMobile = () => Math.min(window.innerWidth, window.innerHeight) < 520;

    function resize(){
      dpr = Math.max(1, Math.min(2, window.devicePixelRatio || 1));
      w = window.innerWidth; h = window.innerHeight;
      canvas.width = Math.floor(w * dpr);
      canvas.height = Math.floor(h * dpr);
      canvas.style.width = w + "px";
      canvas.style.height = h + "px";
      ctx.setTransform(dpr,0,0,dpr,0,0);
    }

    function rand(min,max){ return Math.random()*(max-min)+min; }

    function setPartyFromDate(){
      const nowTZ = nowInTZAsUTCDate(TZ);
      const mm = nowTZ.getUTCMonth()+1;
      const dd = nowTZ.getUTCDate();
      party = (mm === 12 && dd === 31) || (mm === 1 && dd === 1);
    }

    function launchRocket(x = rand(w*0.08, w*0.92)){
      const startY = h + rand(20, 120);
      const targetY = rand(h*0.12, h*0.92); // ‚úÖ ahora puede explotar en casi toda la pantalla
      rockets.push({
        x,
        y: startY,
        vx: rand(-0.7, 0.7),
        vy: rand(-12.5, -9.5),
        targetY,
        hue: rand(0, 360),
        life: rand(40, 90),
        trail: []
      });
    }

    function burst(x,y,hue){
      const count = Math.floor(rand(isMobile()? 70 : 110, isMobile()? 120 : 190));
      const base = hue + rand(-18, 18);

      // anillo principal
      for(let i=0;i<count;i++){
        const a = rand(0, Math.PI*2);
        const sp = rand(1.2, 6.2);
        sparks.push({
          x, y,
          vx: Math.cos(a)*sp,
          vy: Math.sin(a)*sp,
          g: 0.06,
          drag: 0.985,
          hue: base + rand(-25, 25),
          alpha: rand(0.55, 0.98),
          r: rand(1.0, isMobile()? 2.1 : 2.5),
          ttl: rand(55, 150),
          age: 0,
          tw: rand(0.6, 1.3) // ‚Äútwinkle‚Äù
        });
      }

      // centro brillante (pocas part√≠culas lentas)
      const core = Math.floor(rand(12, 26));
      for(let i=0;i<core;i++){
        const a = rand(0, Math.PI*2);
        const sp = rand(0.6, 2.3);
        sparks.push({
          x, y,
          vx: Math.cos(a)*sp,
          vy: Math.sin(a)*sp,
          g: 0.05,
          drag: 0.99,
          hue: base + rand(-10, 10),
          alpha: rand(0.35, 0.70),
          r: rand(1.2, 2.8),
          ttl: rand(45, 110),
          age: 0,
          tw: rand(0.7, 1.1)
        });
      }
    }

    function glowDot(x,y,r,hue,a){
      ctx.globalAlpha = a * 0.18;
      ctx.fillStyle = `hsla(${hue} 100% 75% / 1)`;
      ctx.beginPath(); ctx.arc(x,y,r*4.0,0,Math.PI*2); ctx.fill();

      ctx.globalAlpha = a;
      ctx.fillStyle = `hsla(${hue} 100% 70% / 1)`;
      ctx.beginPath(); ctx.arc(x,y,r,0,Math.PI*2); ctx.fill();
    }

    function step(){
      // fade suave (sin borrar ‚Äúduro‚Äù)
      ctx.fillStyle = `rgba(0,0,0,${party ? 0.13 : 0.09})`;
      ctx.fillRect(0,0,w,h);

      // cohetes
      for(let i=rockets.length-1;i>=0;i--){
        const r = rockets[i];

        // trail
        r.trail.push({x:r.x, y:r.y});
        if(r.trail.length > (isMobile()? 8 : 12)) r.trail.shift();

        r.x += r.vx;
        r.y += r.vy;
        r.vy += 0.05;     // gravedad ligera
        r.vx *= 0.995;
        r.life--;

        // dibujar estela
        ctx.globalAlpha = 0.65;
        for(let t=0;t<r.trail.length;t++){
          const p = r.trail[t];
          const a = (t+1)/r.trail.length * 0.6;
          glowDot(p.x, p.y, 1.1, r.hue, a);
        }
        ctx.globalAlpha = 1;

        // ‚Äúhead‚Äù
        glowDot(r.x, r.y, 1.5, r.hue, 0.9);

        if(r.y <= r.targetY || r.life <= 0){
          burst(r.x, r.y, r.hue);
          rockets.splice(i,1);
        }
      }

      // part√≠culas
      for(let i=sparks.length-1;i>=0;i--){
        const p = sparks[i];
        p.age++;
        p.x += p.vx;
        p.y += p.vy;

        p.vy += p.g;
        p.vx *= p.drag;
        p.vy *= p.drag;

        const t = p.age / p.ttl;
        let a = p.alpha * (1 - t);

        // twinkle
        a *= (0.75 + 0.25*Math.sin(p.age * p.tw));

        glowDot(p.x, p.y, p.r, p.hue, Math.max(0, a));

        if(p.age >= p.ttl) sparks.splice(i,1);
      }

      // auto-launch si party
      if(party){
        const maxRockets = isMobile()? 7 : 12;
        const chance = isMobile()? 0.22 : 0.30;
        if(rockets.length < maxRockets && Math.random() < chance){
          launchRocket();
          if(!isMobile() && Math.random() < 0.30) launchRocket();
        }
      }

      requestAnimationFrame(step);
    }

    function manualShow(){
      // varias explosiones en TODA la pantalla
      const bursts = isMobile()? 3 : 5;
      for(let i=0;i<bursts;i++){
        setTimeout(()=>{
          const x = rand(w*0.10, w*0.90);
          const y = rand(h*0.12, h*0.92); // ‚úÖ full screen
          burst(x, y, rand(0, 360));
        }, i*(isMobile()? 220 : 170));
      }
    }

    resize();
    setPartyFromDate();
    window.addEventListener("resize", resize);
    setInterval(setPartyFromDate, 60_000);
    requestAnimationFrame(step);

    return { manualShow, refreshParty: setPartyFromDate };
  })();

  // =========================
  // TZ select
  // =========================
  function setupTZSelect(){
    const sel = document.getElementById("tzSelect");
    sel.innerHTML = "";

    for(const opt of TZ_OPTIONS){
      const o = document.createElement("option");
      o.value = opt.id;
      o.textContent = opt.label;
      if(opt.id === TZ) o.selected = true;
      sel.appendChild(o);
    }

    sel.addEventListener("change", () => {
      TZ = sel.value;
      localStorage.setItem(STORAGE_KEY, TZ);
      updateText();
      loadWeatherForTZ();
      FX.refreshParty();
    });
  }

  // =========================
  // Init
  // =========================
  setupTZSelect();
  updateText();
  setInterval(updateText, 1000);
  loadWeatherForTZ();

  // Button fireworks
  const btn = document.getElementById("btnFire");
  const btnLabel = document.getElementById("btnFireLabel");
  btn.addEventListener("click", () => {
    btn.disabled = true;
    btnLabel.textContent = "¬°Boom! üéá";
    FX.manualShow();
    setTimeout(() => {
      btn.disabled = false;
      btnLabel.textContent = "Lanzar fuegos artificiales";
    }, 1200);
  });
</script>
</body>
</html>
