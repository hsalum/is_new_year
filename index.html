<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>¬øEs A√±o Nuevo?</title>
  <meta name="theme-color" content="#060a1f" />

  <style>
    :root{
      --bg1:#05061a;
      --bg2:#0b0f2a;
      --card: rgba(255,255,255,.06);
      --stroke: rgba(255,255,255,.12);
      --text: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.68);
      --gold:#ffd166;
      --pink:#ff4d8d;
      --cyan:#37d6ff;
      --neon:#7c5cff;
      --mint:#2ee6a6;
    }

    *{ box-sizing:border-box; }
    html, body { height: 100%; }

    body{
      margin:0;
      min-height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:28px;
      color:var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, "Noto Sans", Arial;
      background:
        radial-gradient(900px 500px at 15% 15%, rgba(55,214,255,.16), transparent 60%),
        radial-gradient(900px 500px at 85% 25%, rgba(255,77,141,.14), transparent 60%),
        radial-gradient(900px 650px at 50% 120%, rgba(124,92,255,.20), transparent 60%),
        linear-gradient(180deg, var(--bg1), var(--bg2));
      overflow:hidden;
    }

    canvas#fx{
      position:fixed;
      inset:0;
      pointer-events:none;
      z-index:0;
    }

    .stars{
      position:fixed;
      inset:0;
      pointer-events:none;
      z-index:0;
      opacity:.55;
      background-image:
        radial-gradient(1px 1px at 12% 18%, rgba(255,255,255,.55), transparent 60%),
        radial-gradient(1px 1px at 84% 22%, rgba(255,255,255,.40), transparent 60%),
        radial-gradient(1px 1px at 55% 62%, rgba(255,255,255,.35), transparent 60%),
        radial-gradient(1px 1px at 32% 78%, rgba(255,255,255,.42), transparent 60%),
        radial-gradient(1px 1px at 70% 86%, rgba(255,255,255,.28), transparent 60%);
      filter: blur(.15px);
    }

    .wrap{
      width:min(860px, 100%);
      text-align:center;
      position:relative;
      z-index:1;
    }

    .card{
      position:relative;
      padding:28px 22px 22px;
      border-radius:22px;
      background:var(--card);
      border:1px solid var(--stroke);
      backdrop-filter: blur(10px);
      box-shadow: 0 30px 90px rgba(0,0,0,.45);
      overflow:hidden;
    }

    .glowTop{
      position:absolute;
      inset:-90px -110px auto -110px;
      height:210px;
      background: radial-gradient(closest-side, rgba(124,92,255,.18), transparent 70%);
      filter: blur(10px);
      pointer-events:none;
    }

    .badge{
      display:inline-flex;
      align-items:center;
      gap:10px;
      padding:8px 12px;
      border-radius:999px;
      border:1px solid var(--stroke);
      background: rgba(0,0,0,.18);
      color:var(--muted);
      font-size:13px;
      margin-bottom:14px;
      user-select:none;
    }

    .dot{
      width:9px;
      height:9px;
      border-radius:50%;
      background:var(--mint);
      box-shadow:0 0 0 6px rgba(46,230,166,.12);
      animation:pulse 1.6s ease-in-out infinite;
      flex: 0 0 auto;
    }

    @keyframes pulse{
      0%,100%{ transform:scale(1); opacity:1 }
      50%{ transform:scale(1.2); opacity:.8 }
    }

    select{
      appearance:none;
      border:1px solid rgba(255,255,255,.18);
      background:rgba(0,0,0,.2);
      color:var(--text);
      padding:6px 28px 6px 10px;
      border-radius:999px;
      font-size:13px;
      cursor:pointer;
      outline:none;
    }

    .selectWrap{ position:relative; display:inline-flex; align-items:center; }
    .chev{
      position:absolute;
      right:10px;
      opacity:.7;
      pointer-events:none;
      font-size:12px;
      transform: translateY(1px);
    }

    h1{
      margin:10px 0 6px;
      font-size:clamp(42px, 6vw, 76px);
      letter-spacing:-0.02em;
    }

    .yes{
      background:linear-gradient(90deg,var(--gold),var(--pink),var(--cyan));
      -webkit-background-clip:text;
      background-clip:text;
      color:transparent;
      text-shadow: 0 0 40px rgba(255,209,102,.06);
    }

    .no{
      background:linear-gradient(90deg,#fff,rgba(255,255,255,.55));
      -webkit-background-clip:text;
      background-clip:text;
      color:transparent;
    }

    .sub{
      font-size:clamp(16px,2.2vw,20px);
      color:var(--muted);
      margin: 8px 0 0;
    }

    .big{
      margin-top:14px;
      font-size:clamp(18px,2.4vw,22px);
      color: rgba(255,255,255,.86);
    }

    .emojiLeft{
      position:absolute; left:18px; top:18px;
      font-size:18px; opacity:.8;
      filter: drop-shadow(0 10px 18px rgba(0,0,0,.35));
      user-select:none;
    }
    .emojiRight{
      position:absolute; right:18px; top:18px;
      font-size:18px; opacity:.8;
      filter: drop-shadow(0 10px 18px rgba(0,0,0,.35));
      user-select:none;
    }

    /* BIG PUSH BUTTON */
    .btnRow{
      margin-top: 16px;
      display:flex;
      gap:10px;
      justify-content:center;
      flex-wrap: wrap;
    }

    .pushBtn{
      border: 1px solid rgba(255,255,255,.18);
      background: rgba(0,0,0,.22);
      color: rgba(255,255,255,.92);
      padding: 14px 18px;
      border-radius: 999px;
      cursor: pointer;
      font-size: 14px;
      letter-spacing: .2px;
      user-select:none;
      display:inline-flex;
      align-items:center;
      gap:10px;

      box-shadow:
        0 18px 45px rgba(0,0,0,.35),
        0 0 0 1px rgba(255,255,255,.04) inset;

      transition: transform .08s ease, background .15s ease, border-color .15s ease, box-shadow .15s ease;
      min-width: 280px;
      justify-content:center;
    }
    .pushBtn:hover{
      background: rgba(0,0,0,.30);
      border-color: rgba(255,255,255,.26);
      box-shadow:
        0 22px 55px rgba(0,0,0,.45),
        0 0 0 1px rgba(255,255,255,.05) inset;
    }
    .pushBtn:active{
      transform: translateY(2px);
    }
    .pushBtn:disabled{
      opacity:.60;
      cursor:not-allowed;
      transform:none;
    }
    .pushBtn .ico{
      font-size: 16px;
      filter: drop-shadow(0 10px 18px rgba(0,0,0,.35));
    }

    .miniBtn{
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.16);
      color: rgba(255,255,255,.78);
      padding: 12px 14px;
      border-radius: 999px;
      cursor: pointer;
      font-size: 13px;
      letter-spacing: .2px;
      user-select:none;
      transition: transform .08s ease, background .15s ease, border-color .15s ease;
      display:inline-flex;
      align-items:center;
      gap:8px;
    }
    .miniBtn:hover{ background: rgba(0,0,0,.24); border-color: rgba(255,255,255,.20); }
    .miniBtn:active{ transform: translateY(1px); }

    /* Toast */
    .toast{
      position: fixed;
      left: 50%;
      top: 18px;
      transform: translateX(-50%);
      z-index: 5;
      padding: 10px 12px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.28);
      backdrop-filter: blur(10px);
      color: rgba(255,255,255,.88);
      font-size: 13px;
      letter-spacing: .2px;
      opacity: 0;
      pointer-events:none;
      transition: opacity .18s ease, transform .18s ease;
      box-shadow: 0 18px 55px rgba(0,0,0,.35);
      display:flex;
      align-items:center;
      gap:10px;
    }
    .toast.show{
      opacity: 1;
      transform: translateX(-50%) translateY(4px);
    }

    .weather{
      margin-top: 18px;
      text-align:left;
      border-top: 1px solid rgba(255,255,255,.12);
      padding-top: 14px;
    }
    .weatherTitle{
      display:flex; align-items:center; justify-content:space-between;
      gap:10px;
      color: rgba(255,255,255,.86);
      font-size: 13px;
      letter-spacing: .2px;
      margin-bottom: 10px;
      user-select:none;
    }
    .weatherGrid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    .wxCard{
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.14);
      border-radius: 16px;
      padding: 12px;
    }
    .wxTop{
      display:flex; align-items:center; justify-content:space-between;
      margin-bottom: 6px;
      color: rgba(255,255,255,.86);
      font-size: 13px;
    }
    .wxMeta{
      color: rgba(255,255,255,.64);
      font-size: 12px;
      line-height: 1.35;
    }
    .wxBig{
      margin-top: 8px;
      color: rgba(255,255,255,.86);
      font-size: 14px;
    }
    .wxNote{
      margin-top: 8px;
      color: rgba(255,255,255,.55);
      font-size: 12px;
    }

    @media (max-width:520px){
      .weatherGrid{ grid-template-columns: 1fr; }
      .pushBtn{ min-width: 100%; }
    }
  </style>
</head>

<body>
  <div class="stars"></div>
  <canvas id="fx"></canvas>

  <div class="toast" id="toast"><span>‚ú®</span><span id="toastText">Listo</span></div>

  <div class="wrap">
    <div class="card">
      <div class="glowTop"></div>
      <div class="emojiLeft" id="leftEmoji">‚ú®</div>
      <div class="emojiRight" id="rightEmoji">üåô</div>

      <div class="badge">
        <span class="dot"></span>
        <span>Horario</span>
        <span class="selectWrap">
          <select id="tzSelect" aria-label="Seleccionar zona horaria"></select>
          <span class="chev">‚ñæ</span>
        </span>
      </div>

      <h1 id="answer">‚Ä¶</h1>
      <p class="sub" id="subtitle">‚Ä¶</p>
      <p class="big" id="countdown">‚Ä¶</p>

      <div class="btnRow">
        <button class="pushBtn" id="btnFire" type="button" title="Dispara una tanda de fuegos en la pantalla">
          <span class="ico">üéÜ</span>
          <span id="btnFireLabel">Lanzar fuegos artificiales</span>
        </button>

        <button class="miniBtn" id="btnWeather" type="button" title="Reintentar clima">
          <span>üå§Ô∏è</span><span>Reintentar clima</span>
        </button>
      </div>

      <section class="weather">
        <div class="weatherTitle">
          <span>üå§Ô∏è Clima para brindar (31/12 y 01/01)</span>
          <span style="color:rgba(255,255,255,.55); font-size:12px;" id="wxLoc"></span>
        </div>

        <div class="weatherGrid">
          <div class="wxCard">
            <div class="wxTop">
              <div id="wxDate31">31/12</div>
              <div id="wxEmoji31">‚Ä¶</div>
            </div>
            <div class="wxMeta" id="wxMeta31">Cargando‚Ä¶</div>
            <div class="wxBig" id="wxBig31"></div>
            <div class="wxNote" id="wxNote31"></div>
          </div>

          <div class="wxCard">
            <div class="wxTop">
              <div id="wxDate01">01/01</div>
              <div id="wxEmoji01">‚Ä¶</div>
            </div>
            <div class="wxMeta" id="wxMeta01">Cargando‚Ä¶</div>
            <div class="wxBig" id="wxBig01"></div>
            <div class="wxNote" id="wxNote01"></div>
          </div>
        </div>

        <div class="wxNote" style="margin-top:10px" id="wxFooter"></div>
      </section>
    </div>
  </div>

<script>
  // -----------------------------
  // Utils UI
  // -----------------------------
  let toastTimer = null;
  function showToast(text, icon="‚ú®"){
    const t = document.getElementById("toast");
    document.getElementById("toastText").textContent = text;
    t.firstElementChild.textContent = icon;

    t.classList.add("show");
    clearTimeout(toastTimer);
    toastTimer = setTimeout(()=> t.classList.remove("show"), 1600);
  }

  // -----------------------------
  // TZ + contador
  // -----------------------------
  const TZ_OPTIONS = [
    { id:"America/Argentina/Buenos_Aires", label:"Argentina (Buenos Aires)" },
    { id:"America/Mexico_City", label:"M√©xico (CDMX)" },
    { id:"America/Santiago", label:"Chile (Santiago)" },
    { id:"America/Lima", label:"Per√∫ (Lima)" },
    { id:"America/Bogota", label:"Colombia (Bogot√°)" },
    { id:"America/New_York", label:"USA (New York)" },
    { id:"America/Los_Angeles", label:"USA (Los √Ångeles)" },
    { id:"Europe/Madrid", label:"Espa√±a (Madrid)" }
  ];

  const TZ_GEO = {
    "America/Argentina/Buenos_Aires": { name:"Buenos Aires", lat:-34.6037, lon:-58.3816 },
    "America/Mexico_City": { name:"CDMX", lat:19.4326, lon:-99.1332 },
    "America/Santiago": { name:"Santiago", lat:-33.4489, lon:-70.6693 },
    "America/Lima": { name:"Lima", lat:-12.0464, lon:-77.0428 },
    "America/Bogota": { name:"Bogot√°", lat:4.7110, lon:-74.0721 },
    "America/New_York": { name:"New York", lat:40.7128, lon:-74.0060 },
    "America/Los_Angeles": { name:"Los √Ångeles", lat:34.0522, lon:-118.2437 },
    "Europe/Madrid": { name:"Madrid", lat:40.4168, lon:-3.7038 }
  };

  const STORAGE_KEY = "esanionuevo_tz";
  let TZ = localStorage.getItem(STORAGE_KEY) || "America/Argentina/Buenos_Aires";

  function nowInTZAsUTCDate(tz){
    const parts = new Intl.DateTimeFormat("en-US",{
      timeZone:tz,
      year:"numeric",month:"2-digit",day:"2-digit",
      hour:"2-digit",minute:"2-digit",second:"2-digit",
      hour12:false
    }).formatToParts(new Date());

    const get = t => Number(parts.find(p=>p.type===t).value);
    return new Date(Date.UTC(get("year"), get("month")-1, get("day"), get("hour"), get("minute"), get("second")));
  }

  function isNewYear(d){ return d.getUTCMonth()===0 && d.getUTCDate()===1; }

  function nextNewYear(d){
    const y = d.getUTCFullYear();
    const m = d.getUTCMonth()+1;
    const day = d.getUTCDate();
    const next = (m>1 || (m===1 && day>1)) ? y+1 : y;
    return new Date(Date.UTC(next,0,1,0,0,0));
  }

  function pad(n){ return String(n).padStart(2,"0"); }

  function update(){
    const now = nowInTZAsUTCDate(TZ);

    const a = document.getElementById("answer");
    const st = document.getElementById("subtitle");
    const c = document.getElementById("countdown");
    const leftEmoji = document.getElementById("leftEmoji");
    const rightEmoji = document.getElementById("rightEmoji");

    if(isNewYear(now)){
      a.textContent="S√≠.";
      a.className="yes";
      st.textContent="¬°Hoy es A√±o Nuevo! üéâ";
      c.textContent="Salud, abrazos y nuevos comienzos ü•Ç‚ú®";
      leftEmoji.textContent = "üéÜ";
      rightEmoji.textContent = "ü•Ç";
      return;
    }

    a.textContent="No :(";
    a.className="no";
    st.textContent="Todav√≠a no es A√±o Nuevo.";

    const diff = nextNewYear(now) - now;
    const sec = Math.max(0, Math.ceil(diff/1000));
    const h = Math.floor(sec/3600);
    const m = Math.floor((sec%3600)/60);
    const s = sec%60;

    c.textContent = `Faltan ${h}h ${pad(m)}m ${pad(s)}s para A√±o Nuevo.`;
    leftEmoji.textContent = "‚ú®";
    rightEmoji.textContent = "üåô";
  }

  function setupTZ(){
    const sel = document.getElementById("tzSelect");
    sel.innerHTML = "";
    TZ_OPTIONS.forEach(o=>{
      const opt=document.createElement("option");
      opt.value=o.id;
      opt.textContent=o.label;
      if(o.id===TZ) opt.selected=true;
      sel.appendChild(opt);
    });
    sel.addEventListener("change", ()=>{
      TZ=sel.value;
      localStorage.setItem(STORAGE_KEY,TZ);
      update();
      refreshWeather(true);
      FX.setModeFromDate();
      showToast("Zona horaria actualizada", "üïí");
    });
  }

  // -----------------------------
  // Fondo: luces minimal siempre + fuegos solo 31/12 y 01/01
  // + funci√≥n manualShow() (bot√≥n)
  // -----------------------------
  const FX = (() => {
    const canvas = document.getElementById("fx");
    const ctx = canvas.getContext("2d", { alpha: true });

    let w=0, h=0, dpr=1;
    let mode = "calm"; // calm | party
    const rockets = [];
    const parts = [];
    const orbs = [];

    const isMobile = () => Math.min(window.innerWidth, window.innerHeight) < 520;

    function cfg(){
      const party = (mode === "party");
      return {
        fadeAlpha: party ? (isMobile()? 0.14 : 0.12) : 0.08,
        gravity: party ? 0.055 : 0.03,

        // autom√°tico
        maxRockets: party ? (isMobile()? 10 : 16) : 0,
        launchChance: party ? (isMobile()? 0.22 : 0.30) : 0,
        burstMin: party ? (isMobile()? 48 : 70) : 0,
        burstMax: party ? (isMobile()? 88 : 120) : 0,

        // manual (bot√≥n)
        manualBurstMin: isMobile()? 65 : 95,
        manualBurstMax: isMobile()? 120 : 170,

        pMin: 1.0,
        pMax: isMobile()? 2.1 : 2.4,
        orbCount: isMobile()? 18 : 28,
      };
    }
    let CFG = cfg();

    function resize(){
      dpr = Math.max(1, Math.min(2, window.devicePixelRatio || 1));
      w = window.innerWidth;
      h = window.innerHeight;
      canvas.width = Math.floor(w * dpr);
      canvas.height = Math.floor(h * dpr);
      canvas.style.width = w + "px";
      canvas.style.height = h + "px";
      ctx.setTransform(dpr,0,0,dpr,0,0);
      CFG = cfg();
      initOrbs();
    }

    function rand(min,max){ return Math.random()*(max-min)+min; }

    function initOrbs(){
      orbs.length = 0;
      for(let i=0;i<CFG.orbCount;i++){
        orbs.push({
          x: rand(0,w),
          y: rand(0,h),
          r: rand(18, 52),
          vx: rand(-0.12, 0.12),
          vy: rand(-0.08, 0.08),
          hue: rand(185, 335),
          a: rand(0.06, 0.14)
        });
      }
    }

    function setModeFromDate(){
      const nowTZ = nowInTZAsUTCDate(TZ);
      const mm = nowTZ.getUTCMonth()+1;
      const dd = nowTZ.getUTCDate();
      const shouldParty = (mm === 12 && dd === 31) || (mm === 1 && dd === 1);
      mode = shouldParty ? "party" : "calm";
      CFG = cfg();
      rockets.length = 0;
    }

    function launch(){
      const x = rand(w*0.10, w*0.90);
      rockets.push({
        x,
        y: h + rand(10, 80),
        vx: rand(-0.9, 0.9),
        vy: rand(-13.6, -10.8),
        targetY: rand(h*0.14, h*0.55),
        life: rand(30, 70),
        hue: rand(190, 340),
      });
    }

    function burstAt(x,y,hueBase, minCount, maxCount){
      const count = Math.floor(rand(minCount, maxCount));
      for(let i=0;i<count;i++){
        const a = rand(0, Math.PI*2);
        const sp = rand(1.6, 5.8);
        const hue = hueBase + rand(-28, 28);
        const alpha = rand(0.55, 0.95);
        const r = rand(CFG.pMin, CFG.pMax);
        const ttl = rand(55, 130);

        parts.push({
          x, y,
          vx: Math.cos(a)*sp,
          vy: Math.sin(a)*sp,
          hue,
          alpha,
          r,
          ttl,
          age: 0
        });
      }
    }

    function drawGlowCircle(x,y,r, hue, alpha){
      ctx.globalAlpha = alpha * 0.22;
      ctx.fillStyle = `hsla(${hue} 100% 75% / 1)`;
      ctx.beginPath();
      ctx.arc(x,y,r*3.2,0,Math.PI*2);
      ctx.fill();

      ctx.globalAlpha = alpha;
      ctx.fillStyle = `hsla(${hue} 100% 70% / 1)`;
      ctx.beginPath();
      ctx.arc(x,y,r,0,Math.PI*2);
      ctx.fill();
    }

    function step(){
      ctx.fillStyle = `rgba(0,0,0,${CFG.fadeAlpha})`;
      ctx.fillRect(0,0,w,h);

      // lucecitas
      for(const o of orbs){
        o.x += o.vx; o.y += o.vy;
        if(o.x < -80) o.x = w+80;
        if(o.x > w+80) o.x = -80;
        if(o.y < -80) o.y = h+80;
        if(o.y > h+80) o.y = -80;

        ctx.globalAlpha = o.a;
        ctx.fillStyle = `hsla(${o.hue} 100% 70% / 1)`;
        ctx.beginPath();
        ctx.arc(o.x,o.y,o.r,0,Math.PI*2);
        ctx.fill();
      }
      ctx.globalAlpha = 1;

      // Part√≠culas (sirve para modo calm + disparos manuales)
      for(let i=parts.length-1;i>=0;i--){
        const p = parts[i];
        p.age++;
        p.x += p.vx;
        p.y += p.vy;
        p.vy += (mode === "party") ? CFG.gravity : 0.04;
        p.vx *= 0.985;
        p.vy *= 0.985;

        const t = p.age / p.ttl;
        const fade = (1 - t);
        const a = p.alpha * fade;

        drawGlowCircle(p.x, p.y, p.r, p.hue, a);
        if(p.age >= p.ttl) parts.splice(i,1);
      }

      if(mode === "party"){
        for(let i=rockets.length-1;i>=0;i--){
          const r = rockets[i];
          r.x += r.vx;
          r.y += r.vy;
          r.vy += CFG.gravity*0.22;
          r.life--;

          ctx.globalAlpha = 0.85;
          ctx.fillStyle = "rgba(255,255,255,0.9)";
          ctx.beginPath();
          ctx.arc(r.x, r.y, 1.35, 0, Math.PI*2);
          ctx.fill();

          if(r.y <= r.targetY || r.life <= 0){
            burstAt(r.x, r.y, r.hue, CFG.burstMin, CFG.burstMax);
            rockets.splice(i,1);
          }
        }

        if(rockets.length < CFG.maxRockets && Math.random() < CFG.launchChance){
          launch();
          if(!isMobile() && Math.random() < 0.35) launch();
        }

        if(parts.length < (isMobile()? 950 : 1900) && Math.random() < 0.02){
          burstAt(rand(w*0.15,w*0.85), rand(h*0.18,h*0.50), rand(190,340), CFG.burstMin, CFG.burstMax);
        }
      }

      ctx.globalAlpha = 1;
      requestAnimationFrame(step);
    }

    function manualShow(){
      const bursts = isMobile() ? 3 : 5;
      for(let i=0;i<bursts;i++){
        setTimeout(() => {
          burstAt(
            rand(w*0.18, w*0.82),
            rand(h*0.18, h*0.52),
            rand(190, 340),
            CFG.manualBurstMin,
            CFG.manualBurstMax
          );
        }, i * (isMobile() ? 190 : 150));
      }
    }

    resize();
    setModeFromDate();
    window.addEventListener("resize", resize);
    requestAnimationFrame(step);
    setInterval(setModeFromDate, 60_000);

    return { setModeFromDate, manualShow };
  })();

  // -----------------------------
  // Clima (31/12 y 01/01) - Open-Meteo robusto
  // -----------------------------
  const WEATHER_CACHE_TTL_MS = 30 * 60 * 1000; // 30 min

  function isoDateUTC(y,m,d){
    return `${y}-${String(m).padStart(2,"0")}-${String(d).padStart(2,"0")}`;
  }

  function getDec31AndJan1Dates(nowTZ){
    const ny = nextNewYear(nowTZ);
    const targetYear = ny.getUTCFullYear();
    const dec31 = { y: targetYear-1, m: 12, d: 31 };
    const jan01 = { y: targetYear,   m: 1,  d: 1  };
    return {
      dec31Iso: isoDateUTC(dec31.y, dec31.m, dec31.d),
      jan01Iso: isoDateUTC(jan01.y, jan01.m, jan01.d),
      yearHint: `${dec31.y} ‚Üí ${jan01.y}`
    };
  }

  function wxLabelFromCode(code){
    const c = Number(code);
    if([0].includes(c)) return { emoji:"‚òÄÔ∏è", txt:"Despejado" };
    if([1,2].includes(c)) return { emoji:"üå§Ô∏è", txt:"Parcialmente nublado" };
    if([3].includes(c)) return { emoji:"‚òÅÔ∏è", txt:"Nublado" };
    if([45,48].includes(c)) return { emoji:"üå´Ô∏è", txt:"Niebla / bruma" };
    if([51,53,55].includes(c)) return { emoji:"üå¶Ô∏è", txt:"Llovizna" };
    if([61,63,65].includes(c)) return { emoji:"üåßÔ∏è", txt:"Lluvia" };
    if([66,67].includes(c)) return { emoji:"üåßÔ∏è", txt:"Lluvia helada" };
    if([71,73,75,77].includes(c)) return { emoji:"üå®Ô∏è", txt:"Nieve" };
    if([80,81,82].includes(c)) return { emoji:"üåßÔ∏è", txt:"Chubascos" };
    if([95].includes(c)) return { emoji:"‚õàÔ∏è", txt:"Tormentas" };
    if([96,99].includes(c)) return { emoji:"‚õàÔ∏è", txt:"Tormentas fuertes" };
    return { emoji:"üåô", txt:"Variable" };
  }

  function partyAdvice(wx){
    const { emoji, txt } = wx;
    if(emoji === "‚õàÔ∏è") return "Pro tip: brindis bajo techo y playlist a todo volumen.";
    if(emoji === "üåßÔ∏è" || emoji === "üå¶Ô∏è") return "Paraguas + zapatillas sacrificables. Brindar igual: s√≠.";
    if(emoji === "üå´Ô∏è") return "Niebla m√≠stica: ideal para foto aesthetic (y abrigo).";
    if(emoji === "üå®Ô∏è") return "Modo polar activado: brindis con guantes, por favor.";
    if(emoji === "‚òÄÔ∏è") return "Clima premium: terraza y brindis con vista.";
    if(emoji === "üå§Ô∏è") return "Bastante bien: abrigo liviano y a disfrutar.";
    return `Clima ${txt.toLowerCase()}: improvisar con estilo.`;
  }

  function setWxLoading(){
    ["31","01"].forEach(k=>{
      document.getElementById(`wxEmoji${k}`).textContent = "‚Ä¶";
      document.getElementById(`wxMeta${k}`).textContent = "Cargando‚Ä¶";
      document.getElementById(`wxBig${k}`).textContent = "";
      document.getElementById(`wxNote${k}`).textContent = "";
    });
    document.getElementById("wxFooter").textContent = "";
  }

  function setWxError(msg, footer=""){
    ["31","01"].forEach(k=>{
      document.getElementById(`wxEmoji${k}`).textContent = "ü§∑";
      document.getElementById(`wxMeta${k}`).textContent = "No pude traer el clima.";
      document.getElementById(`wxBig${k}`).textContent = msg || "Prob√° reintentar.";
      document.getElementById(`wxNote${k}`).textContent = "";
    });
    document.getElementById("wxFooter").textContent = footer;
  }

  function paintWx(dayKey, label, wxTxt, emoji, tmin, tmax, wind, pr){
    document.getElementById(`wxEmoji${dayKey}`).textContent = emoji;
    document.getElementById(`wxMeta${dayKey}`).textContent = `${label} ¬∑ ${wxTxt}`;
    document.getElementById(`wxBig${dayKey}`).textContent =
      `üå°Ô∏è ${Math.round(tmin)}¬∞ / ${Math.round(tmax)}¬∞ ¬∑ üí® ${Math.round(wind)} km/h ¬∑ üíß ${Math.round(pr)} mm`;
    document.getElementById(`wxNote${dayKey}`).textContent =
      partyAdvice({emoji, txt: wxTxt});
  }

  function cacheKeyForTZ(tz){
    return `esanionuevo_weather_cache_${tz}`;
  }

  function readCache(tz){
    try{
      const raw = localStorage.getItem(cacheKeyForTZ(tz));
      if(!raw) return null;
      const obj = JSON.parse(raw);
      if(!obj || !obj.ts || !obj.data) return null;
      if(Date.now() - obj.ts > WEATHER_CACHE_TTL_MS) return null;
      return obj.data;
    }catch{ return null; }
  }

  function writeCache(tz, data){
    try{
      localStorage.setItem(cacheKeyForTZ(tz), JSON.stringify({ ts: Date.now(), data }));
    }catch{}
  }

  async function fetchWithTimeout(url, timeoutMs){
    const ctrl = new AbortController();
    const t = setTimeout(() => ctrl.abort(), timeoutMs);
    try{
      const res = await fetch(url, { cache:"no-store", signal: ctrl.signal });
      return res;
    } finally {
      clearTimeout(t);
    }
  }

  async function fetchWeatherJSON(url, attempts=3){
    let lastErr = null;
    for(let i=0;i<attempts;i++){
      try{
        const res = await fetchWithTimeout(url, 15000); // 15s
        if(!res.ok) throw new Error(`HTTP ${res.status}`);
        return await res.json();
      }catch(e){
        lastErr = e;
        // backoff suave
        await new Promise(r => setTimeout(r, 350 + i*450));
      }
    }
    throw lastErr || new Error("Fetch failed");
  }

  async function refreshWeather(force=false){
    setWxLoading();

    const geo = TZ_GEO[TZ] || TZ_GEO["America/Argentina/Buenos_Aires"];
    document.getElementById("wxLoc").textContent = `üìç ${geo.name}`;

    const nowTZ = nowInTZAsUTCDate(TZ);
    const { dec31Iso, jan01Iso, yearHint } = getDec31AndJan1Dates(nowTZ);

    // cache
    if(!force){
      const cached = readCache(TZ);
      if(cached){
        try{
          renderWeatherFromData(cached, dec31Iso, jan01Iso, yearHint, geo);
          return;
        }catch{
          // si el cache est√° raro, seguimos al fetch
        }
      }
    }

    const api = new URL("https://api.open-meteo.com/v1/forecast");
    api.searchParams.set("latitude", String(geo.lat));
    api.searchParams.set("longitude", String(geo.lon));
    api.searchParams.set("timezone", "auto");
    api.searchParams.set("forecast_days", "16");
    api.searchParams.set("daily", [
      "weather_code",
      "temperature_2m_max",
      "temperature_2m_min",
      "precipitation_sum",
      "windspeed_10m_max"
    ].join(","));

    try{
      const data = await fetchWeatherJSON(api.toString(), 3);
      writeCache(TZ, data);
      renderWeatherFromData(data, dec31Iso, jan01Iso, yearHint, geo);
      showToast("Clima actualizado", "üå§Ô∏è");
    }catch(e){
      const msg = (e && e.name === "AbortError")
        ? "La API tard√≥ demasiado (timeout)."
        : "No pude conectar con la API.";

      setWxError(
        `${msg} Prob√° ‚ÄúReintentar clima‚Äù.`,
        `Si est√°s en una red corporativa/AdBlock/DNS estricto, puede bloquear api.open-meteo.com. ¬∑ Fechas: ${yearHint}`
      );
    }
  }

  function renderWeatherFromData(data, dec31Iso, jan01Iso, yearHint, geo){
    const daily = data?.daily;
    const times = daily?.time || [];
    const idx31 = times.indexOf(dec31Iso);
    const idx01 = times.indexOf(jan01Iso);

    if(idx31 === -1 || idx01 === -1){
      setWxError(
        "El pron√≥stico no llega hasta esas fechas (la API suele dar ~16 d√≠as).",
        `Ubicaci√≥n: ${geo.name}. Ventana: ${times[0] || "?"} ‚Üí ${times[times.length-1] || "?"}. ¬∑ Fechas: ${yearHint}`
      );
      return;
    }

    const wx31 = wxLabelFromCode(daily.weather_code[idx31]);
    const wx01 = wxLabelFromCode(daily.weather_code[idx01]);

    paintWx("31", dec31Iso, wx31.txt, wx31.emoji,
      daily.temperature_2m_min[idx31], daily.temperature_2m_max[idx31],
      daily.windspeed_10m_max[idx31], daily.precipitation_sum[idx31]
    );

    paintWx("01", jan01Iso, wx01.txt, wx01.emoji,
      daily.temperature_2m_min[idx01], daily.temperature_2m_max[idx01],
      daily.windspeed_10m_max[idx01], daily.precipitation_sum[idx01]
    );

    document.getElementById("wxFooter").textContent =
      `Fuente: Open-Meteo. Ubicaci√≥n aproximada para la TZ: ${geo.name}. Fechas: ${yearHint}.`;
  }

  // -----------------------------
  // Init
  // -----------------------------
  setupTZ();
  update();
  setInterval(update, 250);
  refreshWeather(false);

  // Bot√≥n fuegos (push + texto ‚ÄúRecargando‚Ä¶‚Äù + toast)
  const btnFire = document.getElementById("btnFire");
  const btnFireLabel = document.getElementById("btnFireLabel");

  btnFire.addEventListener("click", () => {
    btnFire.disabled = true;
    btnFireLabel.textContent = "Recargando‚Ä¶";
    FX.manualShow();
    showToast("Fuegos lanzados", "üéÜ");
    setTimeout(() => {
      btnFire.disabled = false;
      btnFireLabel.textContent = "Lanzar fuegos artificiales";
    }, 1300);
  });

  // Bot√≥n reintentar clima
  document.getElementById("btnWeather").addEventListener("click", () => {
    showToast("Reintentando clima‚Ä¶", "üå§Ô∏è");
    refreshWeather(true);
  });
</script>
</body>
</html>
